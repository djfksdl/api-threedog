<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ay">


	<!-- 반려견등록 -->
	<insert id="petInsert" parameterType="com.javaex.vo.DogVo">
      <![CDATA[
		INSERT INTO dog 
		(
		dogName,
		kind,
		weight,
		birth,
		gender,
		neutering,
		experience,
		bite,
		memo,
		dogImg,
		size,
		skin,
		heart,
		marking,
		mounting,
		uNo
		)
		SELECT
		#{dogName},
		#{kind},
		#{weight},
		#{birth},
		#{gender},
		#{neutering},
		#{experience},
		#{bite},
		#{memo},
		#{dogImg},
		#{size},
		#{skin},
		#{heart},
		#{marking},
		#{mounting},
		#{uNo}
		FROM DUAL
		WHERE EXISTS (SELECT 1 FROM dog WHERE uNo = #{uNo})

  ]]>
	</insert>


	<!-- 리뷰 등록 -->
	<insert id="addReview01" parameterType="com.javaex.vo.ReviewVo">
        <![CDATA[
            insert into review (rNo, bNo, uNo, star, rContent, rDate)
            values (null, #{bNo}, #{uNo}, #{star}, #{rContent}, #{rDate})
        ]]>
		<selectKey keyProperty="rNo" resultType="int" order="AFTER">
            <![CDATA[
                select last_insert_id()
            ]]>
		</selectKey>
	</insert>

	<!-- 리뷰 이미지 등록 -->
	<insert id="addReview02" parameterType="map">
        <![CDATA[
            insert into reviewimg (riNo, rNo, saveName, orgName, filePath)
            values (null, #{rNo}, #{saveName}, #{orgName}, #{filePath})
        ]]>
	</insert>

	<!-- 포인트 추가 -->
	<update id="updatePoint" parameterType="com.javaex.vo.ReviewVo">
	
        <![CDATA[
           update point set usePoint=usePoint+1000  ,pDate=#{rDate}
			where uNo=#{uNo} and rvNum=#{rNo}
        ]]>
	</update>

	<!--가게정보1개 가져오기 -->
	<select id="selectOne" parameterType="int" resultType="com.javaex.vo.BusinessVo">
		<![CDATA[
		select b.bNo, b.bPhone, b.bAddress, b.bdAddress, b.title ,b.logo, round(avg(r.star),1) averageStar
		from business b 
		join review r on b.bNo=r.bNo
		where b.bNo=#{bNo};
		]]>
	</select>




</mapper>