<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ye">

	<!-- 사업자 회원가입 -->
	<insert id="bInsert" parameterType="com.javaex.vo.BusinessVo">
      <![CDATA[
      ]]>
		insert into business (bNo, bId, bPw, bNum, bZipCode, bAddress, bdAddress, bPhone, latitude, longitude)
		values (
		null,
		#{bId}, #{bPw}, #{bNum},
		#{bZipCode},
		#{bAddress}, #{bdAddress},
		#{bPhone}, #{latitude}, #{longitude})
	</insert>
	<!-- 사업자 회원가입 -->

	<!-- 사업자 회원가입 - 중복 체크 -->
	<select id="bSelect" resultType="int">
		<![CDATA[
			select count(*) count from business
			where bId = #{bId}
		]]>
	</select>
	<!-- 사업자 회원가입 - 중복 체크 -->

	<!-- 사업자 로그인 -->
	<select id="bSelectOne" parameterType="com.javaex.vo.BusinessVo" resultType="com.javaex.vo.BusinessVo">
		<![CDATA[
			select * from business
			where bId = #{bId} and bPw = #{bPw}
		]]>
	</select>
	<!-- 사업자 로그인 -->

	<!-- 검색 화면 리스트, 조회순 -->
	<select id="searchlist" resultType="com.javaex.vo.ReviewListVo">
		<![CDATA[
			select r.rNo, r.star, b.title, ri.saveName, b.bNo
			from review r
			join business b on r.bNo = b.bNo
			left join reviewimg ri on r.rNo = ri.rNo
			order by r.views desc
		]]>
	</select>
	<!-- 검색 화면 리스트 -->


	<!-- 지도, 캘린더 검색 -->
	<select id="searchmap" resultType="com.javaex.vo.StoreVo">
		<![CDATA[
			SELECT b.bNo, b.title, b.logo,
			       (3959 * acos(cos(radians(COALESCE(#{lat}, b.latitude))) * cos(radians(b.latitude)) 
			       * cos(radians(b.longitude) - radians(COALESCE(#{lan}, b.longitude))) + sin(radians(COALESCE(#{lat}, b.latitude))) 
			       * sin(radians(b.latitude)))) AS distance
		FROM business b
		LEFT JOIN (
		        SELECT bNo, COUNT(*) as reserved_count
		        FROM reserve
		        GROUP BY bNo
		        ) r ON b.bNo = r.bNo
		LEFT JOIN (
		        SELECT bNo, COUNT(*) as reserved_time_count
		        FROM reserveTime
		        WHERE rtDate = COALESCE(#{rsDate}, rtDate)
		        GROUP BY bNo
		        ) rt ON b.bNo = rt.bNo
		WHERE (r.reserved_count IS NULL OR r.reserved_count < (
		        SELECT MAX(count_per_bNo) FROM (
		            SELECT COUNT(*) as count_per_bNo
		            FROM reserve
		            GROUP BY bNo
		        ) as subquery
		    )
		    ) AND (rt.reserved_time_count IS NULL OR rt.reserved_time_count < (
		        SELECT MAX(count_per_bNo) FROM (
		            SELECT COUNT(*) as count_per_bNo
		            FROM reserveTime
		            WHERE rtDate = COALESCE(#{rsDate}, rtDate)
		            GROUP BY bNo
		        ) as subquery
		    )
		    )
		ORDER BY distance ASC
		]]>
	</select>

	<!-- 그냥 가게 리스트 -->
	<select id="mainlist" resultType="com.javaex.vo.StoreVo">
    <![CDATA[
        SELECT b.bNo, b.title, b.logo,
           (3959 * acos(cos(radians(COALESCE(#{lat}, b.latitude))) * cos(radians(b.latitude)) 
           * cos(radians(b.longitude) - radians(COALESCE(#{lan}, b.longitude))) + sin(radians(COALESCE(#{lat}, b.latitude))) 
           * sin(radians(b.latitude)))) AS distance,  latitude lat, longitude lan
        FROM business b
        ORDER BY distance ASC
        limit 10
    ]]>
	</select>
	<!-- 그냥 가게 리스트 -->
	
	<!-- 가게들 마커 표시 -->
	<select id="marklist" resultType="com.javaex.vo.BusinessVo">
		<![CDATA[
			select bNo, title, latitude, longitude from business
		]]>
	</select>
	<!-- 가게들 마커 표시 -->

	<!-- 인기 검색어 리스트 -->
	<select id="poplist" resultType="com.javaex.vo.StoreVo">
    <![CDATA[
        SELECT b.title, COUNT(r.rsNo) AS reservationCount
		FROM business b
		JOIN reserve r ON b.bNo = r.bNo
		JOIN reserveTime rt ON r.rtNo = rt.rtNo
		WHERE rt.rtDate >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
		GROUP BY b.bNo, b.title
		ORDER BY reservationCount DESC
		LIMIT 5
    ]]>
	</select>
	<!-- 인기 검색어 리스트 -->


</mapper>