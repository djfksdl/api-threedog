<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jw">

	<!-- ************************ 스케줄 화면 ***************************** -->

	<!-- 한 가게의 예약 리스트 정보 조회 -->
	<select id="selectReserveList" parameterType="int" resultType="com.javaex.vo.ReserveVo">
		<![CDATA[
		SELECT r.*, d.*, p.*, b.*, rt.rtDate, rt.rtTime
		FROM reserve r
		JOIN dog d ON r.dogNo = d.dogNo
		JOIN rsPrice rp ON r.rsNo = rp.rsNo
		JOIN price p ON rp.priceNo = p.priceNo
		JOIN beautylist b ON p.beautyNo = b.beautyNo
		JOIN reserveTime rt ON r.rtNo = rt.rtNo
		WHERE rt.bNo = #{bNo}
		GROUP BY r.rsNo;
		 ]]>
	</select>

	<!-- 일자 수정 -->
	<update id="updateReserveDate" parameterType="com.javaex.vo.ReserveVo">
		<![CDATA[
		UPDATE reserveTime
		SET rtDate = #{rtDate}
		WHERE rtNo = (SELECT rtNo 
		              FROM reserve 
		              WHERE rsNo =#{rsNo});
		               ]]>
	</update>


	<!-- 시간 수정 -->
	<update id="updateReserveTime" parameterType="com.javaex.vo.ReserveVo">
		<![CDATA[
		UPDATE reserveTime
		SET rtTime = #{rtTime}
		WHERE rtNo = (SELECT rtNo 
		              FROM reserve 
		              WHERE rsNo = #{rsNo});
		              ]]>
	</update>


	<!-- 예약 정보 삭제 -->
	<delete id="deleteReserve" parameterType="int">
		<!-- rsPrice 테이블에서 해당 예약 번호에 연결된 모든 행 삭제 -->
    <![CDATA[
        DELETE FROM rsPrice WHERE rsNo = #{rsNo};
    ]]>
	</delete>

	<delete id="deleteReserve2" parameterType="int">
		<!-- reserve 테이블에서 예약 번호 삭제 -->
    <![CDATA[
        DELETE FROM reserve WHERE rsNo = #{rsNo};
    ]]>
	</delete>

	<update id="updateReserveTimeFinishByRsNo" parameterType="int">
		<!-- 해당 예약 번호에 연결된 예약 시간의 rtFinish 값을 0으로 업데이트 -->
    <![CDATA[
       UPDATE reserveTime 
       SET rtFinish = 0 
       WHERE rtNo = (SELECT rtNo FROM reserve WHERE rsNo = #{rsNo});
    ]]>  
	</update>

	<!-- ************************ 알림장 화면 ***************************** -->

	<!-- 특정 예약의 미용 기록 조회 -->
	<select id="selectGroomingRecord" parameterType="int" resultType="com.javaex.vo.ReserveVo"> 
	   <![CDATA[
	      SELECT r.*, d.*, p.*, b.*, rt.rtDate, rt.rtTime, ai.*, push.*
	      FROM reserve r
	      JOIN dog d ON r.dogNo = d.dogNo
	      JOIN rsPrice rp ON r.rsNo = rp.rsNo
	      JOIN price p ON rp.priceNo = p.priceNo
	      JOIN beautylist b ON p.beautyNo = b.beautyNo
	      JOIN reserveTime rt ON r.rtNo = rt.rtNo
	      LEFT JOIN afterImg ai ON 
	      r.rsNo = ai.rsNo
	      LEFT JOIN push ON r.rsNo = push.rsNo
	      WHERE r.rsNo = #{rsNo}
	      GROUP BY r.rsNo;
	   ]]>
	</select>

	<!-- 미용 기록 업데이트 쿼리 -->
	<update id="updateGroomingRecord" parameterType="com.javaex.vo.ReserveVo">
	  <![CDATA[
	    UPDATE reserve
	    SET expectedPrice = #{expectedPrice},
	        attitude = #{attitude},
	        rCondition = #{rCondition},
	        tangle = #{tangle},
	        disliked = #{disliked},
	        bath = #{bath},
	        surcharge = #{surcharge},
	        message = #{message},
	        curruntWeight = #{curruntWeight}
	    WHERE rsNo = #{rsNo};
	    ]]>
	</update>

	<!-- 이미지 정보 삽입 쿼리 -->

	<insert id="insertAfterImg" parameterType="map">
	    <![CDATA[
	    INSERT INTO afterImg (rsNo, saveName)
	    VALUES (#{rsNo}, #{saveName});
	    ]]>
	</insert>
	
		<!-- 푸시 알림 삽입 쿼리 -->
	<insert id="insertPushNotification" parameterType="int">
	    <![CDATA[
	    INSERT INTO push (rsNo, pushTime)
	    VALUES (#{rsNo}, NOW());
	    ]]>
	</insert>

</mapper>